name: Build ImmortalWRT ARM64 RootFS

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch of ImmortalWRT'
        default: 'master'

jobs:
  build-rootfs:
    runs-on: ubuntu-latest
    env:
      ROOTFS_NAME: immortalwrt-arm64-rootfs.tar.gz

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git build-essential libncurses5-dev gawk \
          gettext unzip file bc curl ccache python3 python3-venv python3-pip python3-setuptools

      - name: Clone ImmortalWRT
        run: |
          git clone --depth 1 --branch ${{ github.event.inputs.branch }} https://github.com/immortalwrt/immortalwrt.git
          cp .github/immortalwrt-config immortalwrt/.config
          cd immortalwrt

          # 添加自定义 feeds
          echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall.git" >> feeds.conf.default
          echo "src-git helloworld https://github.com/fw876/helloworld.git" >> feeds.conf.default

          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds update passwall helloworld
          ./scripts/feeds install -a
          make defconfig
          make -j$(nproc) download
          make -j$(nproc)
          if [ -d bin/targets/armsr/armv8 ]; then
              TAR_DIR=bin/targets/armsr/armv8
          elif [ -d bin/targets/aarch64_generic ]; then
              TAR_DIR=bin/targets/aarch64_generic
          else
              echo "ERROR: No target rootfs found"
              exit 1
          fi

         tar -czf ../$ROOTFS_NAME -C $TAR_DIR .
      - name: Upload RootFS
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ROOTFS_NAME }}
          path: ${{ env.ROOTFS_NAME }}
